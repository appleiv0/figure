# 동물가족화 검사 로직 분석

## 목차
1. [검사 개요](#검사-개요)
2. [스테이지별 플로우](#스테이지별-플로우)
3. [동물 분류 체계](#동물-분류-체계)
4. [기능/역기능 판정 로직](#기능역기능-판정-로직)
5. [스테이지별 점수 산출](#스테이지별-점수-산출)
6. [최종 판정 기준](#최종-판정-기준)
7. [데이터 흐름](#데이터-흐름)
8. [LLM 대화 로직](#llm-대화-로직)

---

## 검사 개요

동물가족화 검사는 **투사 기법(Projective Technique)**을 활용한 부모-자녀 관계 진단 모델이다. 아동이 동물을 선택하고 배치하는 과정에서 가족 관계의 역동, 자기 인식, 소망을 파악한다.

### 핵심 원리
- 아동은 동물 상징을 통해 **방어 기제를 우회**하여 내면을 표현
- 선택한 동물의 **유형(가해자형/피해자형)**이 관계 패턴을 반영
- **현실 인식 vs 소망** 간의 차이가 역기능 수준을 나타냄
- 공간 배치를 통한 **정서적 거리감** 측정

### 검사 구성
| 스테이지 | 주제 | 수집 데이터 | 관계(relation) |
|---------|------|-----------|---------------|
| Stage 0 | 소개 | - | - |
| Stage 1 | 나라고 생각하는 동물 | 동물 4개 + 이유 | 나 |
| Stage 2 | 되고 싶은 동물 | 동물 4개 + 이유 | 나(소망) |
| Stage 3 | 가족을 동물로 표현 | 가족 구성원별 동물 1개 + 이유 | 가족 구성원명 |
| Stage 4 | 동물 배치 (친밀도) | 공간 좌표 + 방향 | 가족 구성원명 |
| Stage 5 | 가족이 되었으면 하는 동물 | 가족 구성원별 동물 1개 + 이유 | 가족 구성원명 |
| Stage 6 | 가족이 보는 나 | 가족 구성원별 동물 1개 + LLM 대화 | 가족 구성원명 |

---

## 스테이지별 플로우

### Stage 0 - 소개
```
챗봇 "푸름이" 자기소개 → 검사 안내 → 시작 버튼
```

### Stage 1 - 나라고 생각하는 동물 (자기 인식)
```
32종 동물 중 4개 선택 → 선택 완료 →
  [동물1 카드] "어떤 부분이 나랑 닮았다고 생각했어?" → 응답 →
  "그렇구나." → [동물2 카드] → 응답 → ... (4번 반복) →
  Stage 2로 이동
```
- **목적**: 아동의 현재 자기 인식 파악
- **분석 포인트**: 피해자형 동물 선택 여부 → 낮은 자존감, 취약성 시사
- **저장**: `figures.1[]` (relation: "나")

### Stage 2 - 되고 싶은 동물 (소망하는 자기)
```
32종 동물 중 4개 선택 → 선택 완료 →
  [동물1 카드] "왜 [동물]이/가 되고 싶어?" → 응답 →
  "그렇구나." → [동물2 카드] → 응답 → ... (4번 반복) →
  가족 선택 → Stage 3로 이동
```
- **목적**: 아동의 변화 욕구 파악
- **분석 포인트**: 희망형/부정형 동물 비율 → 변화 욕구 강도
- **저장**: `figures.2[]` (relation: "나(소망)")

### Stage 3 - 가족을 동물로 (가족 인식)
```
가족 구성원 선택 (엄마, 아빠, 형, 누나 등) →
  각 가족 구성원마다:
    동물 1개 선택 → "왜 [가족]이/가 [동물] 같다고 생각했을까?" → 응답 →
    다음 가족 구성원 반복 →
  Stage 4로 이동
```
- **목적**: 아동이 인식하는 가족 구성원의 특성
- **분석 포인트**: 성인 가족이 가해자형 + 아동이 피해자형 → 권력 불균형/위협
- **저장**: `figures.3[]` (relation: 각 가족 구성원명)

### Stage 4 - 동물 배치 (친밀도/정서적 거리)
```
캔버스에 가족 동물 카드 표시 →
  드래그로 친한 동물끼리 가까이 배치 →
  배치 완료 → 거리 계산 → 친밀도 메시지 생성 →
  Stage 5로 이동
```
- **목적**: 가족 구성원 간 정서적 거리 측정
- **분석 포인트**: 아동(나)이 양쪽 부모 모두와 멀거나 밀착 → 정서적 고립/과밀착
- **저장**: `positions` (좌표, 방향), `friendly_message`

### Stage 5 - 가족이 되었으면 하는 동물 (가족 소망)
```
각 가족 구성원마다:
  "현재 [가족]은 [동물]인데, 어떤 동물이 되었으면 좋겠어?" →
  동물 1개 선택 → "왜 되었으면 좋겠어?" → 응답 →
  다음 가족 구성원 반복 →
  Stage 6로 이동
```
- **목적**: 현실과 소망의 차이(Gap Analysis)
- **분석 포인트**: 가해자형→희망형 변화 욕구가 클수록 불만족 시사
- **저장**: `figures.5[]` (relation: 각 가족 구성원명)

### Stage 6 - 가족이 보는 나 (타인 시선)
```
각 가족 구성원마다:
  "가족이 나를 어떤 동물로 볼까?" →
  동물 1개 선택 → 이유 설명 →
  LLM이 맥락적 후속 질문 2회 →
  위로/공감 메시지 →
  다음 가족 구성원 반복 →
  종료 화면으로 이동
```
- **목적**: 아동이 인식하는 가족의 시선 파악
- **분석 포인트**: 부정적/피해자형 동물 선택 → 부정적 자기 평가
- **저장**: `figures.6[]`, `llmCompletion`, `chatHistory`

---

## 동물 분류 체계

### 가해자형 동물 (Abuser Animals) - 13종
> 강하고 위협적인 이미지의 동물

| 동물 | 상징 |
|------|------|
| 코끼리 | 크고 압도적인 힘 |
| 불곰 | 공격성, 위압감 |
| 흑표범 | 은밀한 위협 |
| 사자 | 지배, 권력 |
| 상어 | 공포, 잔인함 |
| 공룡 | 거대한 위협 |
| 호랑이 | 두려움, 분노 |
| 돼지 | 탐욕, 불결 |
| 코브라 | 독, 교활함 |
| 뱀 | 불신, 위험 |
| 도마뱀 | 냉혈, 무감각 |
| 악어 | 잔인함, 공격성 |
| 독수리 | 감시, 포식 |

### 피해자형 동물 (Victim Animals) - 11종
> 약하고 수동적인 이미지의 동물

| 동물 | 상징 |
|------|------|
| 병아리 | 약함, 무력함 |
| 나비 | 연약함, 덧없음 |
| 조개 | 은둔, 자기 보호 |
| 개구리 | 작음, 무시당함 |
| 돌 | 무감각, 동결 |
| 강아지 | 의존성, 순종 |
| 고슴도치 | 방어적, 가시 |
| 양 | 순종, 희생 |
| 새끼양 | 극도의 취약함 |
| 토끼 | 두려움, 도피 |
| 알에서 나오는 병아리 | 미성숙, 불안정 |

### 희망 긍정형 동물 (Hope Positive) - 9종
> 긍정적 변화 소망을 나타내는 동물

| 동물 |
|------|
| 학, 일반새, 돌고래, 나비, 새끼팬더, 말, 강아지, 양, 새끼양 |

### 희망 부정형 동물 (Hope Negative) - 13종
> 공격적/부정적 소망을 나타내는 동물

가해자형 동물과 동일 (코끼리, 불곰, 흑표범, 사자, 상어, 공룡, 호랑이, 돼지, 코브라, 뱀, 도마뱀, 악어, 독수리)

---

## 기능/역기능 판정 로직

### 판정 결과 3단계

| 판정 | 의미 | 조건 |
|------|------|------|
| **기능적** | 정상 범위의 가족 기능 | Stage 1+2+3 중 하나라도 비해당 |
| **역기능 가능성** | 역기능적 가족 관계 가능성 | Stage 1+2+3 모두 해당 |
| **역기능** | 역기능적 가족 관계 확인 | Stage 1+2+3 모두 해당 + Stage 4 또는 6 해당 |

### 판정 플로우차트
```
┌─────────────────────────────────────────┐
│ Stage 1 점수 + Stage 2 점수 + Stage 3 점수 │
│              합계 = 3인가?                │
└────────────┬────────────────┬───────────┘
             │                │
          YES ▼             NO ▼
  ┌──────────────────┐  ┌──────────────┐
  │ Stage 4 + Stage 6 │  │   기능적      │
  │  합계 ≥ 1인가?    │  │ (정상 범위)   │
  └────┬─────────┬───┘  └──────────────┘
       │         │
    YES ▼      NO ▼
┌──────────┐ ┌─────────────┐
│  역기능   │ │ 역기능 가능성 │
│ (확인됨)  │ │  (주의 필요)  │
└──────────┘ └─────────────┘
```

---

## 스테이지별 점수 산출

### Stage 1 점수 (자기 인식) - 0 또는 1점
```
조건: 선택한 4개 동물 중 피해자형 동물이 1개 이상
결과: abuse["1"] = 1, score += 1
의미: 아동이 스스로를 약하고 취약한 존재로 인식
```

**예시:**
- 병아리, 토끼, 사자, 돌고래 → 피해자형 2개 (병아리, 토끼) → **1점**
- 사자, 호랑이, 돌고래, 말 → 피해자형 0개 → **0점**

### Stage 2 점수 (변화 소망) - 0 또는 1점
```
조건: (희망 긍정형 ≥ 1 OR 희망 부정형 ≥ 1) AND 해당 동물 합계 ≥ 3
결과: abuse["2"] = 1, score += 1
의미: 현재 상태에서 벗어나고 싶은 강한 욕구
```

**예시:**
- 학, 돌고래, 강아지, 말 → 긍정형 4개 → **1점**
- 사자, 호랑이, 코끼리, 돌고래 → 부정형 3 + 긍정형 1 = 4개 → **1점**
- 돌고래, 고양이, 원숭이, 펭귄 → 긍정형 1 + 부정형 0 = 1개 → **0점**

### Stage 3 점수 (가족 인식) - 0 또는 1점
```
조건: 성인 가족 구성원 중 가해자형 동물 ≥ 1
  AND 아동(나) 또는 형제가 피해자형 동물 ≥ 1
결과: abuse["3"] = 1, score += 1
의미: 가족 내 힘의 불균형, 위협적 관계 인식
```

**예시:**
- 아빠=상어, 엄마=토끼, 나=병아리 → 가해자형(상어) + 피해자형(병아리) → **1점**
- 아빠=강아지, 엄마=고양이, 나=토끼 → 가해자형 0개 → **0점**

### Stage 4 점수 (공간 배치) - 0 또는 1점
```
조건: 아동(나)이 양쪽 부모 모두와 멀리 있거나 밀착
  (far 또는 contact 상태)
결과: abuse["4"] = 1, score += 1
의미: 양쪽 부모 모두와의 정서적 단절 또는 과밀착
```

**거리 계산 기준:**
- **접촉(contact)**: 카드 간 겹침 발생
- **가까움(near)**: 적정 거리 내
- **멀리(far)**: 캔버스 기준 일정 거리 초과

### Stage 6 점수 (타인 시선) - 0 또는 1점
```
조건: 가족이 나를 부정형(가해자형) 또는 피해자형 동물로 본다고 인식 ≥ 1
결과: abuse["6"] = 1, score += 1
의미: 가족으로부터 부정적 평가를 받고 있다고 느낌
```

**예시:**
- 엄마가 나를 조개로 봄 → 피해자형 → **1점**
- 아빠가 나를 돌고래로 봄 → 해당 없음 → **0점**

---

## 최종 판정 기준

### 점수 해석 테이블

| 총점 | Stage 1 | Stage 2 | Stage 3 | Stage 4 | Stage 6 | 판정 |
|------|---------|---------|---------|---------|---------|------|
| 0-2 | * | * | * | * | * | 기능적 |
| 3 | 1 | 1 | 1 | 0 | 0 | 역기능 가능성 |
| 4 | 1 | 1 | 1 | 1 | 0 | 역기능 |
| 4 | 1 | 1 | 1 | 0 | 1 | 역기능 |
| 5 | 1 | 1 | 1 | 1 | 1 | 역기능 |

### 판정 코드
```python
if abuse[1] + abuse[2] + abuse[3] == 3:
    # 핵심 3단계 모두 해당
    if abuse[4] + abuse[6] >= 1:
        report = "역기능 있습니다"        # 확정적 역기능
    else:
        report = "역기능 가능성 있습니다"   # 가능성 수준
else:
    report = "기능적입니다"               # 정상 범위
```

### 핵심 원칙
1. **Stage 1 + 2 + 3이 핵심 판별 기준**: 자기 인식(피해자형) + 변화 욕구(강함) + 가족 인식(가해자-피해자 구조) 3가지가 동시에 충족되어야 역기능 의심
2. **Stage 4, 6은 보조 확인**: 공간 배치와 타인 시선은 핵심 판별 후 확정 여부를 결정
3. **단일 지표만으로는 역기능 판정 불가**: 최소 3개 스테이지의 복합 지표 필요

---

## 데이터 흐름

### 프론트엔드 → 백엔드 API 호출

```
[등록] POST /createReceiptNo
  → receiptNo 발급, 세션 초기화

[Stage 1-2] POST /setFigure (stage별)
  → figures.{stage}에 동물 배열 저장
  → 점수 계산 후 반환

[Stage 3] POST /setFigure
  → figures.3에 가족별 동물 저장
  → 가해자-피해자 패턴 분석

[Stage 4] POST /setPosition
  → positions에 좌표 저장
  → 거리 계산, 친밀도 메시지 생성
  → 배치 점수 반환

[Stage 5] POST /setFigure
  → figures.5에 소망 동물 저장

[Stage 6] POST /setFigure + POST /llmCompletion
  → figures.6에 인식 동물 저장
  → LLM으로 후속 질문 생성/응답

[전 스테이지] POST /saveChat
  → chatHistory에 대화 기록 누적

[최종] POST /getReport
  → 전체 점수 재계산
  → 판정 메시지 생성
  → 결과 데이터 반환
```

### 데이터 저장 구조
```
MongoDB (Primary)
  └── therapy_sessions collection
       ├── receiptNo (unique index)
       ├── kid { name, sex, birth }
       ├── counselor { organization, name }
       ├── figures { 1:[], 2:[], 3:[], 5:[], 6:[] }
       ├── positions { centerH, centerV, figures[] }
       ├── abuse { 1:0, 2:0, 3:0, 4:0, 6:0 }
       ├── abuser { 가족명: 0/1 }
       ├── score (0-5)
       ├── report ("기능적"/"역기능 가능성"/"역기능")
       ├── llmCompletion { 가족명: { bot:[], user:[] } }
       ├── chatHistory []
       └── status ("in_progress"/"completed")

JSON 파일 (Backup)
  └── /therapy_result/{receiptNo}_{kidName}.json
```

---

## LLM 대화 로직

### Stage 6 LLM 연동 (GPT-3.5-turbo)

Stage 6에서만 LLM을 활용하며, 가족 구성원별 3턴 대화를 진행한다.

#### 턴 0 (첫 번째 질문)
```
입력: Stage 3 데이터(가족→동물) + Stage 6 데이터(가족이 보는 나→동물)
프롬프트: "친절한 상담사로서, 10살 어린이의 친구처럼 대화"
temperature: 0.2

출력 예시:
"그렇구나. 그래서 엄마가 너를 조개라고 생각하고 있구나.
 엄마가 너를 조개로 볼 때 어떤 기분이 들어?"
```

#### 턴 1 (후속 질문)
```
입력: 이전 대화 맥락 + Stage 3, 6 데이터
프롬프트: 위로의 말 + 동물에게 하고 싶은 말 질문
temperature: 0

출력 예시:
"그런 기분이 들었구나. 네 마음이 많이 힘들었겠다.
 조개에게 어떤 말을 하고 싶을까?"
```

#### 턴 2 (마무리)
```
LLM 호출 없이 고정 응답:
"그렇구나. [동물]에게 그렇게 말해주고 싶구나."
→ 다음 가족 구성원으로 이동
```

### LLM 프롬프트 설계 원칙
- **아동 친화적 언어**: 10세 수준의 쉬운 한국어
- **공감 우선**: 판단이 아닌 공감과 수용
- **투사 유지**: 동물 상징을 통한 간접적 표현 유도
- **Few-shot 학습**: 대화 예시 2개를 포함하여 일관성 확보

---

## 부록: 검사 결과 보고서 (PDF) 구성

### 1페이지 - 프로필 및 종합
| 섹션 | 내용 |
|------|------|
| 기본 정보 | 이름, 나이, 성별, 상담기관, 상담사, 검사일 |
| 나 (Stage 1) | 선택 동물 4개 + 이유 |
| 나(소망) (Stage 2) | 선택 동물 4개 + 이유 |
| 가족 (Stage 3) | 가족별 동물 + 이유 + 친밀도 메시지 |
| 나와 가족 관계 (Stage 5, 6) | 소망 동물 + 가족이 보는 나 |
| 진단 결과 | 기능적 / 역기능 가능성 / 역기능 |
| 평가자 소견 | 상담사 작성 영역 |

### 2페이지 - 면담 상세
| 섹션 | 내용 |
|------|------|
| LLM 대화 기록 | 가족 구성원별 질문-응답 테이블 |
| 전체 대화 이력 | 시간순 전체 채팅 기록 |
